version: 0.2

phases:
  install:
    commands:
      - npm config set scripts-prepend-node-path true
      - npm install -g yarn
      - yarn install --frozen-lockfile --ignore-scripts
  pre_build:
    commands:
      - env
      - npx lerna run --stream --scope @cityofboston/deploy-tools --include-filtered-dependencies prepare
      # CodeBuild does not preserve permissions
      - chmod a+x ./deploy/*.sh
  build:
    commands:
      - ./deploy/codepipeline-deploy.sh
artifacts:
  files:
    - imagedefinitions.json
cache:
  paths:
    - '/usr/local/share/.cache/yarn/v3/**/*'
    - 'node_modules/**/*'
